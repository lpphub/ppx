package config

import (
	"errors"

	"github.com/spf13/viper"
)

type DBConfig struct {
	Host     string
	Port     int
	User     string
	Password string
	Dbname   string
}

type RedisConfig struct {
	Host     string
	Port     int
	Password string
	DB       int
}

type JWTConfig struct {
	Secret           string
	ExpireTime       int64 // access_token 过期时间（秒）
	RefreshExpireTime int64 // refresh_token 过期时间（秒）
}

type ServerConfig struct {
	Port int
	Mode string // debug, release, test
}

type Config struct {
	Database DBConfig
	Redis    RedisConfig
	JWT      JWTConfig
	Server   ServerConfig
}

func Load() (*Config, error) {
	v := viper.New()

	// 设置配置文件路径和名称
	v.SetConfigName("conf")
	v.SetConfigType("yml")
	v.AddConfigPath("./config")
	v.AddConfigPath(".")

	// 读取配置文件
	if err := v.ReadInConfig(); err != nil {
		// 如果配置文件不存在，只使用环境变量
		var vErr viper.ConfigFileNotFoundError
		if !errors.As(err, &vErr) {
			return nil, err
		}
	}

	// 自动绑定环境变量，优先级高于配置文件
	v.AutomaticEnv()

	// 从viper读取配置到结构体
	var config Config
	if err := v.Unmarshal(&config); err != nil {
		return nil, err
	}

	return &config, nil
}