package helper

import (
	"strconv"

	"{{.ModuleName}}/pkg/errs"
	"{{.ModuleName}}/web/middleware"

	"github.com/gin-gonic/gin"
	"github.com/lpphub/goweb/base"
	"github.com/lpphub/goweb/pkg/logging"
)

// MustBindJSON 绑定 JSON 并返回 bool，失败返回 false
func MustBindJSON(c *gin.Context, obj any) bool {
	if err := c.ShouldBindJSON(obj); err != nil {
		logging.Errorw(c.Request.Context(), err)
		base.Fail(c, errs.ErrInvalidParam)
		return false
	}
	return true
}

// MustBindQuery 绑定 Query 并返回 bool，失败返回 false
func MustBindQuery(c *gin.Context, obj any) bool {
	if err := c.ShouldBindQuery(obj); err != nil {
		logging.Errorw(c.Request.Context(), err)
		base.Fail(c, errs.ErrInvalidParam)
		return false
	}
	return true
}

// MustGetUserID 获取用户 ID，失败返回 0 + false
func MustGetUserID(c *gin.Context) (uint, bool) {
	userID, ok := middleware.GetUserID(c)
	if !ok {
		base.Fail(c, errs.ErrNoToken)
		return 0, false
	}
	return userID, true
}

// MustParseUintParam 解析 uint 参数，失败返回 0 + false
func MustParseUintParam(c *gin.Context, param string) (uint, bool) {
	id, err := strconv.ParseUint(c.Param(param), 10, 32)
	if err != nil {
		logging.Errorw(c, err)
		base.Fail(c, errs.ErrInvalidParam)
		return 0, false
	}
	return uint(id), true
}

// Respond 统一响应
func Respond(c *gin.Context, err error, data ...any) {
	base.Respond(c, err, data...)
}
