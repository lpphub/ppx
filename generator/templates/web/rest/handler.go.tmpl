package rest

import (
	"{{.ModuleName}}/infra/logger"
	"{{.ModuleName}}/logic"
	"{{.ModuleName}}/logic/shared"
	"{{.ModuleName}}/web/base"
	"{{.ModuleName}}/web/types"

	"github.com/gin-gonic/gin"
)

func Test(c *gin.Context) {
	logger.Info(c, "test1")

	logger.Info(c.Request.Context(), "test2")

	logger.Info(c.Request.Context(), "test3")

	base.OKWithData(c, "ok")
}

func Register(c *gin.Context) {
	var req types.RegisterReq
	if err := c.ShouldBindJSON(&req); err != nil {
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	// 使用auth service注册
	tokenPair, err := logic.Svc.Auth.Register(c, req)
	if err != nil {
		base.FailWithError(c, err)
		return
	}
	base.OKWithData(c, tokenPair)
}

func Login(c *gin.Context) {
	var req types.LoginReq
	if err := c.ShouldBindJSON(&req); err != nil {
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	// 使用auth service登录
	tokenPair, err := logic.Svc.Auth.Login(c, req)
	if err != nil {
		base.FailWithError(c, err)
		return
	}

	base.OKWithData(c, tokenPair)
}

// RefreshToken 刷新 token
func RefreshToken(c *gin.Context) {
	var req struct {
		RefreshToken string `json:"refresh_token" binding:"required"`
	}
	if err := c.ShouldBindJSON(&req); err != nil {
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	// 使用auth service刷新token
	tokenPair, err := logic.Svc.Auth.RefreshToken(c, req.RefreshToken)
	if err != nil {
		base.FailWithError(c, err)
		return
	}
	base.OKWithData(c, tokenPair)
}