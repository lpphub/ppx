package user

import (
	"{{.ModuleName}}/logic"
	"{{.ModuleName}}/logic/shared"
	"{{.ModuleName}}/web/types"
	"strconv"

	"github.com/gin-gonic/gin"
	"github.com/lpphub/goweb/base"
	"github.com/lpphub/goweb/pkg/logger"
)

// List 获取用户列表
func List(c *gin.Context) {
	var req types.UserQueryReq
	if err := c.ShouldBindJSON(&req); err != nil {
		logger.Errw(c.Request.Context(), err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	data, err := logic.Svc.User.List(c.Request.Context(), req)
	if err != nil {
		logger.Errw(c.Request.Context(), err)
		base.FailWithError(c, err)
		return
	}

	base.OKWithData(c, data)
}

// Get 获取单个用户
func Get(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	user, err := logic.Svc.User.Get(c, uint(id))
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}

	base.OKWithData(c, user)
}

// Create 创建用户
func Create(c *gin.Context) {
	var req types.CreateUserReq
	if err := c.ShouldBindJSON(&req); err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	user, err := logic.Svc.User.Create(c, req)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}
	base.OKWithData(c, user)
}

// Update 更新用户
func Update(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	var req types.UpdateUserReq
	if err = c.ShouldBindJSON(&req); err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	err = logic.Svc.User.Update(c, uint(id), req)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}
	base.OK(c)
}

// Delete 删除用户
func Delete(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	err = logic.Svc.User.Delete(c, uint(id))
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}

	base.OK(c)
}

// UpdateStatus 更新用户状态
func UpdateStatus(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	var req types.UpdateStatusReq
	if err = c.ShouldBindJSON(&req); err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	err = logic.Svc.User.UpdateStatus(c, uint(id), req.Status)
	if err != nil {
		base.FailWithError(c, err)
		return
	}

	base.OK(c)
}

// GetUserRoles 获取用户角色列表
func GetUserRoles(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	roleIds, err := logic.Svc.User.GetUserRoles(c, uint(id))
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}

	base.OKWithData(c, roleIds)
}

// AssignRoles 为用户分配角色
func AssignRoles(c *gin.Context) {
	id, err := strconv.ParseUint(c.Param("id"), 10, 32)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	var req types.AssignUserRolesReq
	if err = c.ShouldBindJSON(&req); err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, shared.ErrInvalidParam)
		return
	}

	err = logic.Svc.User.AssignRoles(c, uint(id), req.RoleIds)
	if err != nil {
		logger.Errw(c, err)
		base.FailWithError(c, err)
		return
	}

	base.OK(c)
}